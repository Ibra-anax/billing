<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IFA BAKERY AND JUICE - Saved Bills</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <!-- Firebase CDN with compatibility layer -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-indigo-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">IFA BAKERY AND JUICE</h1>
    <nav class="space-x-4">
      <a href="index.html" class="hover:text-blue-300">Home</a>
      <a href="index1.html" class="hover:text-blue-300">Create Bill</a>
    </nav>
  </header>

  <main class="p-6">
    <h2 class="text-2xl font-bold mb-4">Saved Bills</h2>
    <input id="searchInput" placeholder="Search by name or phone..." class="w-full p-2 border rounded mb-4" />
    <div id="savedBillsContainer" class="space-y-4"></div>
    <div id="pendingTotalDisplay" class="mt-6 text-right text-lg font-bold text-red-600"></div>
  </main>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const firebaseConfig = {
        apiKey: "AIzaSyCUk2M8HUWB2JsLlTB8q8WyZlD_qgOhKXo",
        authDomain: "billing-25855.firebaseapp.com",
        projectId: "billing-25855",
        storageBucket: "billing-25855.appspot.com",
        messagingSenderId: "859747720443",
        appId: "1:859747720443:web:c8eacc73c6b6564219245e",
        measurementId: "G-G79EC8SP9S"
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let allBills = [];
      let expandedCustomer = null;

      function loadBills() {
        const allKeys = Object.keys(localStorage);
        allBills = [];
        allKeys.forEach(key => {
          if (key.startsWith("bills_")) {
            try {
              const bills = JSON.parse(localStorage.getItem(key) || "[]");
              allBills.push(...bills);
            } catch (e) {
              console.error("Invalid JSON in localStorage for key", key);
            }
          }
        });
        displayFilteredBills("");
      }

      function groupBillsByCustomer(bills) {
        const grouped = {};
        bills.forEach(bill => {
          const key = `${bill.name}___${bill.phone}`;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(bill);
        });
        return grouped;
      }

      function deleteSingleBill(customerKey, billId) {
        const localKey = "bills_" + customerKey.replace("___", "_");
        let bills = JSON.parse(localStorage.getItem(localKey)) || [];
        bills = bills.filter(b => b.id !== billId);
        localStorage.setItem(localKey, JSON.stringify(bills));
        loadBills();
      }

      function updateAmountGiven(customerKey, newValue) {
        const grouped = groupBillsByCustomer(allBills);
        const bills = grouped[customerKey];
        const amount = parseFloat(newValue) || 0;
        const eachAmount = amount / bills.length;
        const updatedBills = bills.map(b => ({ ...b, amountGiven: eachAmount }));

        // Save updatedBills into localStorage
        const localKey = "bills_" + customerKey.replace("___", "_");
        localStorage.setItem(localKey, JSON.stringify(updatedBills));

        // Reload allBills from localStorage again to reflect updated amountGiven
        loadBills();
      }

      function exportToPDF(customerKey) {
        const element = document.getElementById(`pdfContent_${customerKey}`);
        const [name] = customerKey.split("___");
        const opt = {
          margin: 0.5,
          filename: `Bill_${name}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
      }

      function printCustomerBill(customerKey) {
        const content = document.getElementById(`pdfContent_${customerKey}`).outerHTML;
        const original = document.body.innerHTML;
        document.body.innerHTML = content;
        const printStyles = `
          <style>
            body { font-family: Arial, sans-serif; }
            h1, h2, h3 { text-align: center; }
            .text-right { text-align: right; }
            .font-bold { font-weight: bold; }
            .bg-white { background-color: white; }
            .rounded { border-radius: 0.25rem; }
          </style>
        `;
        window.print();
        document.body.innerHTML = original;
        location.reload();
      }

      function displayFilteredBills(searchTerm) {
        const container = document.getElementById("savedBillsContainer");
        const pendingTotalDisplay = document.getElementById("pendingTotalDisplay");
        container.innerHTML = "";
        pendingTotalDisplay.textContent = "";

        const grouped = groupBillsByCustomer(allBills);
        let totalPendingAmount = 0;

        Object.entries(grouped).forEach(([key, bills]) => {
          const [name, phone] = key.split("___");
          const match = name.toLowerCase().includes(searchTerm) || phone.includes(searchTerm);
          if (searchTerm && !match) return;

          const div = document.createElement("div");
          div.className = "p-4 bg-white rounded shadow hover:bg-gray-50";

          if (expandedCustomer === key) {
            let totalAmountGiven = 0;
            let totalFinal = 0;

            const billList = bills.map(bill => {
              totalAmountGiven += bill.amountGiven || 0;
              totalFinal += bill.final;
              return `
                <div class="mb-2 border-b pb-2">
                  <p class="text-sm">#${bill.id} | ${bill.date}</p>
                  <p class="text-sm text-gray-600">Notes: ${bill.notes}</p>
                  <p class="font-semibold text-sm">Total: ₹${bill.final}</p>
                  <button onclick="deleteSingleBill('${key}', ${bill.id}); event.stopPropagation();" class="bg-red-500 text-white px-2 py-0.5 mt-1 rounded text-xs">Delete Bill</button>
                </div>
              `;
            }).join("");

            const pending = totalFinal - totalAmountGiven;
            totalPendingAmount += Math.max(0, pending);

            div.innerHTML = `
              <div id="pdfContent_${key}">
                <div class="flex justify-between items-center mb-2">
                  <h3 class="text-lg font-bold">${name} (${phone})</h3>
                  <div class="space-x-2">
                    <a href="index1.html?name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}" class="bg-yellow-500 text-white px-3 py-1 rounded">Add Bill</a>
                    <button onclick="printCustomerBill('${key}'); event.stopPropagation();" class="bg-blue-600 text-white px-3 py-1 rounded">Print</button>
                  </div>
                </div>
                ${billList}
                <div class="mt-2 text-sm text-gray-700">
                  Amount Given:
                  <input type="tel" value="${totalAmountGiven}" class="border p-1 rounded w-32 ml-2" onchange="updateAmountGiven('${key}', this.value)" onclick="event.stopPropagation()" />
                </div>
                <div class="text-right mt-3 font-bold text-green-700">Grand Total: ₹${totalFinal}</div>
                <div class="text-right mt-3 font-bold text-red-700">Balance: ₹${pending}</div>
              </div>
            `;
          } else {
            div.innerHTML = `
              <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold">${name} (${phone})</h3>
                <a href="index1.html?name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}" class="bg-yellow-500 text-white px-3 py-1 rounded">Add Bill</a>
              </div>
              <p class="text-gray-600 text-sm">Total Bills: ${bills.length}</p>
              <p class="text-blue-600 text-sm">Click to view details</p>
            `;
          }

          div.addEventListener("click", () => {
            expandedCustomer = expandedCustomer === key ? null : key;
            displayFilteredBills(searchTerm);
          });

          container.appendChild(div);
        });
      }

      document.getElementById("searchInput").addEventListener("input", function () {
        expandedCustomer = null;
        displayFilteredBills(this.value.trim().toLowerCase());
      });

      window.deleteSingleBill = deleteSingleBill;
      window.printCustomerBill = printCustomerBill;
      window.updateAmountGiven = updateAmountGiven;

      loadBills();
    });
  </script>
</body>
</html>
