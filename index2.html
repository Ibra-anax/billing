<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IFA JUICE & BAKERY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-indigo-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">IFA JUICE & BAKERY</h1>
    <nav class="space-x-4">
      <a href="index.html" class="hover:text-blue-300">Home</a>
      <a href="index1.html" class="hover:text-blue-300">Create Bill</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="p-6">
    <h2 class="text-2xl font-bold mb-4">Saved Bills</h2>

    <!-- Search Field with Icon -->
    <div class="relative mb-4">
      <input
        type="text"
        id="searchInput"
        placeholder="Search by name or phone..."
        class="w-full pl-10 p-2 border rounded"
      />
      <svg
        class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none"
        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"></path>
      </svg>
    </div>

    <!-- Bills Display -->
    <div id="savedBillsContainer" class="space-y-4"></div>
  </main>

<script>
  let allBills = [];

  function loadBills() {
    allBills = JSON.parse(localStorage.getItem("bills") || "[]");
    displayFilteredBills(""); // show all initially
  }

  function groupBillsByCustomer(bills) {
    const grouped = {};
    bills.forEach(bill => {
      const key = `${bill.name}___${bill.phone}`;
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(bill);
    });
    return grouped;
  }

  let expandedCustomer = null;

  function displayFilteredBills(searchTerm) {
    const container = document.getElementById("savedBillsContainer");
    container.innerHTML = "";

    const grouped = groupBillsByCustomer(allBills);
    let found = false;

    Object.entries(grouped).forEach(([key, bills]) => {
      const [name, phone] = key.split("___");
      const match = name.toLowerCase().includes(searchTerm) || phone.includes(searchTerm);

      if (searchTerm && !match) return;

      found = true;

      if (expandedCustomer && expandedCustomer !== key) return;

      const div = document.createElement("div");
      div.className = "p-4 bg-white rounded shadow cursor-pointer hover:bg-gray-50";

      if (expandedCustomer === key) {
        // Show full detail
        let total = 0;
        const billDetails = bills.map(bill => {
          const itemsHtml = bill.items.map(item => {
            const itemTotal = item.qty * item.price;
            total += itemTotal;
            return `<li>${item.name} - ${item.qty} × ₹${item.price} = ₹${itemTotal}</li>`;
          }).join("");

          return `
            <div class="mb-4 border-t pt-2">
              <p><strong>Bill #${bill.id}</strong> | ${bill.date}</p>
              <p><strong>Notes:</strong> ${bill.notes}</p>
              <ul class="ml-5 mt-1 list-disc text-sm text-gray-800">
                ${itemsHtml}
              </ul>
              <div class="text-right mt-2">
                <button class="bg-red-500 text-white text-xs px-2 py-1 rounded" onclick="deleteBill('${key}', ${bill.id})">Delete Bill</button>
              </div>
            </div>
          `;
        }).join("");

        div.innerHTML = `
          <h3 class="text-lg font-bold mb-2">${name} (${phone})</h3>
          ${billDetails}
          <div class="mt-4 font-bold text-right text-indigo-700">Total Amount: ₹${total}</div>
          <div class="text-right mt-2">
            <button class="bg-blue-500 text-white px-3 py-1 rounded mr-2" onclick="printCustomer('${key}')">Print</button>
            <button class="bg-green-500 text-white px-3 py-1 rounded" onclick="shareCustomer('${key}')">Share</button>
          </div>
        `;
      } else {
        // Show summary only
        div.innerHTML = `
          <h3 class="text-lg font-bold mb-2">${name} (${phone})</h3>
          <p class="text-gray-600">Total Bills: ${bills.length}</p>
          <p class="text-blue-600 text-sm">Click to view details</p>
        `;
      }

      div.addEventListener("click", () => {
        expandedCustomer = expandedCustomer === key ? null : key;
        displayFilteredBills(searchTerm);
      });

      container.appendChild(div);
    });

    if (!found) {
      container.innerHTML = "<p class='text-gray-600'>No matching customer found.</p>";
    }
  }

  function deleteBill(customerKey, billId) {
    if (!confirm("Are you sure you want to delete this bill?")) return;

    allBills = allBills.filter(bill => !(bill.id === billId && `${bill.name}___${bill.phone}` === customerKey));

    localStorage.setItem("bills", JSON.stringify(allBills));

    displayFilteredBills(document.getElementById("searchInput").value.trim().toLowerCase());
  }

  document.getElementById("searchInput").addEventListener("input", function () {
    expandedCustomer = null;
    displayFilteredBills(this.value.trim().toLowerCase());
  });

  function printCustomer(key) {
    const [name, phone] = key.split("___");
    const bills = groupBillsByCustomer(allBills)[key];
    let total = 0;
    const billDetails = bills.map(bill => {
      const itemsHtml = bill.items.map(item => {
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        return `${item.name} - ${item.qty} × ₹${item.price} = ₹${itemTotal}`;
      }).join("\n");

      return `
Bill #${bill.id} | ${bill.date}
Notes: ${bill.notes}
Items:
${itemsHtml}
      `;
    }).join("\n\n");

    const content = `
IFA JUICE & BAKERY
Customer: ${name}
Phone: ${phone}

${billDetails}

Total Amount: ₹${total}
    `;

    const newWin = window.open('', '', 'width=600,height=700');
    newWin.document.write(`<pre>${content}</pre><script>window.print();<\/script>`);
    newWin.document.close();
  }

  function shareCustomer(key) {
    const [name, phone] = key.split("___");
    const bills = groupBillsByCustomer(allBills)[key];
    let total = 0;
    const billDetails = bills.map(bill => {
      const itemsText = bill.items.map(item => {
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        return `${item.name} - ${item.qty} × ₹${item.price} = ₹${itemTotal}`;
      }).join("\n");

      return `Bill #${bill.id} | ${bill.date}\nNotes: ${bill.notes}\nItems:\n${itemsText}`;
    }).join("\n\n");

    const shareText = `
IFA JUICE & BAKERY
Customer: ${name}
Phone: ${phone}

${billDetails}

Total Amount: ₹${total}
\nUPI ID: 329347689795920@cnrb
\nClick here to scan QR CODE: https://raw.githubusercontent.com/Ibra-anax/url/2dfc2006ea8d71c6538c38b1c54514511df31783/qr1.jpg
    `;

    if (navigator.share) {
      navigator.share({
        title: `Bill for ${name}`,
        text: shareText
      }).catch(err => console.error("Share failed", err));
    } else {
      navigator.clipboard.writeText(shareText).then(() => {
        alert("Customer bill copied to clipboard!");
      }).catch(() => {
        alert("Copy failed.");
      });
    }
  }

  window.onload = loadBills;
</script>

</body>
</html>
